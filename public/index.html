<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sample Size Calculator | FW Tools</title>
    <meta name="description"
        content="C√¥ng c·ª• t√≠nh to√°n Sample Size v√† ∆∞·ªõc t√≠nh th·ªùi gian Fieldwork cho Market Research">
    <link rel="stylesheet" href="index.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Auth Gate Script -->
    <script type="module">
        import { onAuthChange, checkApproval } from './js/authService.js';

        // Check authentication on page load
        onAuthChange(async (user) => {
            if (!user) {
                window.location.href = 'login.html?redirect=index.html';
                return;
            }

            const status = await checkApproval();
            if (!status.approved) {
                window.location.href = 'login.html?redirect=index.html';
                return;
            }

            // User is authenticated and approved - show content
            document.body.classList.add('authenticated');
        });
    </script>

    <style>
        /* Hide content until authenticated */
        body:not(.authenticated) .app-container {
            display: none;
        }

        body:not(.authenticated)::after {
            content: 'ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p...';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            color: #6b7280;
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- HEADER -->
        <header class="app-header">
            <div class="header-left">
                <img src="logo.png" alt="FW Tools" class="header-logo">
            </div>
            <h1>Sample Size Calculator</h1>
            <div class="header-right">
                <a href="admin.html" class="admin-link" title="Admin">‚öôÔ∏è</a>
            </div>
        </header>

        <main class="main-content-wrapper">
            <!-- SIDEBAR: Project List -->
            <aside class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3>üìÅ D·ª± √°n</h3>
                    <button class="new-project-btn" id="newProjectBtn" title="T·∫°o estimate m·ªõi">+ New</button>
                </div>
                <div class="project-list" id="projectList">
                    <p class="placeholder">ƒêang t·∫£i...</p>
                </div>
                <div class="pagination" id="pagination">
                    <!-- Dynamic pagination -->
                </div>
            </aside>

            <!-- MAIN AREA -->
            <div class="main-content">
                <!-- LEFT COLUMN: INPUT -->
                <section class="input-section">
                    <!-- MODE TOGGLE -->
                    <div class="card mode-card">
                        <div class="mode-toggle">
                            <button class="mode-btn active" data-mode="quick">‚ö° Quick Mode</button>
                            <button class="mode-btn" data-mode="detailed">üìã Detailed Mode</button>
                        </div>
                        <p class="mode-desc" id="modeDescription">Nh·∫≠p nhanh v·ªõi IR t·ª± ƒë·ªông suggest theo Location</p>
                    </div>

                    <!-- TEMPLATE SELECTOR -->
                    <div class="card template-card">
                        <label for="templateSelect">üìã Ch·ªçn Template (t√πy ch·ªçn)</label>
                        <select id="templateSelect">
                            <option value="">-- Ch·ªçn lo·∫°i d·ª± √°n --</option>
                        </select>
                        <div class="audience-indicator hidden" id="audienceIndicator">
                            <div class="audience-info">
                                <span class="audience-icon">üéØ</span>
                                <span class="audience-name" id="audienceNameDisplay">General Population</span>
                                <span class="audience-badge" id="audienceBadge">D·ªÖ</span>
                            </div>
                            <div class="audience-details">
                                <span class="audience-factor" id="audienceFactorDisplay">IR Factor: √ó1.0 | Difficulty:
                                    √ó1.0</span>
                            </div>
                        </div>
                    </div>

                    <!-- INPUT FORM -->
                    <div class="card input-card">
                        <div class="card-header">
                            <h2>üìù Th√¥ng tin D·ª± √°n</h2>
                        </div>

                        <form id="calcForm">
                            <div class="form-group">
                                <label for="projectName">T√™n d·ª± √°n</label>
                                <input type="text" id="projectName" placeholder="V√≠ d·ª•: Brand Health Check Q4...">
                            </div>

                            <div class="form-row">
                                <div class="form-group">
                                    <label for="sampleSize">Quy m√¥ m·∫´u (N) *</label>
                                    <input type="number" id="sampleSize" placeholder="500" min="1" required>
                                </div>
                                <div class="form-group">
                                    <label for="loi">ƒê·ªô d√†i (LOI - Ph√∫t) *</label>
                                    <input type="number" id="loi" placeholder="15" min="1" required>
                                </div>
                            </div>

                            <div class="form-group">
                                <label>V√πng mi·ªÅn / Lo·∫°i Target (Multi-select)</label>
                                <div class="multi-select-container" id="locationMultiSelect">
                                    <div class="select-box" id="locationSelectBox">
                                        <span class="selected-text" id="locationSelectedText">-- Ch·ªçn locations
                                            --</span>
                                        <span class="arrow">‚ñº</span>
                                    </div>
                                    <div class="dropdown-panel hidden" id="locationDropdownPanel">
                                        <!-- Dynamic content populated by JS -->
                                    </div>
                                </div>
                                <div class="ir-suggestion" id="irSuggestion"></div>
                            </div>

                            <!-- DETAILED MODE FIELDS -->
                            <div class="detailed-fields" id="detailedFields">
                                <div class="form-group">
                                    <label for="irDisplay">Incidence Rate (IR%) - <span id="irValue">35</span>%</label>
                                    <input type="range" id="irInput" min="1" max="100" value="35">
                                </div>

                                <div class="form-group">
                                    <label>C·∫•u tr√∫c Quota</label>
                                    <div class="radio-group">
                                        <label class="radio-card selected">
                                            <input type="radio" name="quota" value="simple" checked>
                                            <span class="radio-content">
                                                <span class="radio-title">Simple</span>
                                                <span class="radio-desc">Age, Gender, Region ri√™ng bi·ªát</span>
                                            </span>
                                        </label>
                                        <label class="radio-card">
                                            <input type="radio" name="quota" value="nested">
                                            <span class="radio-content">
                                                <span class="radio-title">Nested</span>
                                                <span class="radio-desc">Interlocking (VD: Male 18-24 HCM)</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label>ƒê·ªô kh√≥ ƒë·ªëi t∆∞·ª£ng (Target)</label>
                                    <div class="radio-group">
                                        <label class="radio-card selected">
                                            <input type="radio" name="target" value="normal" checked>
                                            <span class="radio-content">
                                                <span class="radio-title">Th∆∞·ªùng</span>
                                                <span class="radio-desc">Gen Pop, Mass consumers</span>
                                            </span>
                                        </label>
                                        <label class="radio-card hard-target">
                                            <input type="radio" name="target" value="hard">
                                            <span class="radio-content">
                                                <span class="radio-title">Kh√≥ / Niche</span>
                                                <span class="radio-desc">Doctors, B2B, Specialists</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>

                                <!-- PANEL VENDOR MULTI-SELECT -->
                                <div class="form-group">
                                    <label>üè¢ Panel Source (Ch·ªçn nhi·ªÅu vendors)</label>
                                    <div class="multi-select-container" id="panelMultiSelect">
                                        <div class="select-box" id="panelSelectBox">
                                            <span class="selected-text" id="panelSelectedText">-- Ch·ªçn panel vendors
                                                --</span>
                                            <span class="arrow">‚ñº</span>
                                        </div>
                                        <div class="dropdown-panel hidden" id="panelDropdownPanel">
                                            <!-- Dynamic content populated by JS -->
                                        </div>
                                    </div>
                                </div>

                                <!-- QUOTA SKEW -->
                                <div class="form-group">
                                    <label>üìä Quota Distribution (Ph√¢n b·ªï)</label>
                                    <div class="radio-group radio-group-3">
                                        <label class="radio-card skew-card selected">
                                            <input type="radio" name="quotaSkew" value="balanced" checked>
                                            <span class="radio-content">
                                                <span class="radio-title">‚öñÔ∏è Balanced</span>
                                                <span class="radio-desc">50/50, Age ƒë·ªÅu</span>
                                            </span>
                                        </label>
                                        <label class="radio-card skew-card">
                                            <input type="radio" name="quotaSkew" value="light_skew">
                                            <span class="radio-content">
                                                <span class="radio-title">üìä Skew nh·∫π</span>
                                                <span class="radio-desc">70/30</span>
                                            </span>
                                        </label>
                                        <label class="radio-card skew-card heavy-skew">
                                            <input type="radio" name="quotaSkew" value="heavy_skew">
                                            <span class="radio-content">
                                                <span class="radio-title">üéØ Skew n·∫∑ng</span>
                                                <span class="radio-desc">R·∫•t h·∫πp</span>
                                            </span>
                                        </label>
                                    </div>
                                </div>

                                <!-- QC BUFFER -->
                                <div class="form-group">
                                    <label for="qcBuffer">üîç QC Reject Buffer - <span id="qcValue">10</span>%</label>
                                    <input type="range" id="qcBuffer" min="0" max="60" value="10">
                                    <div class="range-labels">
                                        <span>0%</span>
                                        <span>30%</span>
                                        <span>60%</span>
                                    </div>
                                </div>

                                <!-- FW START DATE & TIMING -->
                                <div class="form-group">
                                    <label for="fwStartDate">üìÖ Ng√†y b·∫Øt ƒë·∫ßu FW (auto-detect l·ªÖ/t·∫øt)</label>
                                    <input type="date" id="fwStartDate">
                                    <div class="timing-warning hidden" id="timingWarning"></div>
                                </div>
                            </div>
                        </form>
                    </div>
                </section>

                <!-- RIGHT COLUMN: RESULTS -->
                <section class="results-section">
                    <!-- QUICK MODE RESULTS -->
                    <div class="card result-card quick-results" id="quickResults">
                        <div class="card-header">
                            <h2>üìä ∆Ø·ªõc t√≠nh Nhanh (3 Scenarios)</h2>
                        </div>

                        <div class="scenarios-grid">
                            <div class="scenario-card best">
                                <div class="scenario-label">üü¢ Best Case</div>
                                <div class="scenario-days" id="bestDays">--</div>
                                <div class="scenario-desc" id="bestDesc">IR cao, target d·ªÖ</div>
                            </div>
                            <div class="scenario-card likely">
                                <div class="scenario-label">üü° Most Likely</div>
                                <div class="scenario-days" id="likelyDays">--</div>
                                <div class="scenario-desc" id="likelyDesc">Theo input hi·ªán t·∫°i</div>
                            </div>
                            <div class="scenario-card worst">
                                <div class="scenario-label">üî¥ Worst Case</div>
                                <div class="scenario-days" id="worstDays">--</div>
                                <div class="scenario-desc" id="worstDesc">IR th·∫•p, target kh√≥</div>
                            </div>
                        </div>
                    </div>

                    <!-- DETAILED MODE RESULTS -->
                    <div class="card result-card detailed-results hidden" id="detailedResults">
                        <div class="card-header">
                            <h2>üìä K·∫øt qu·∫£ Chi ti·∫øt</h2>
                        </div>

                        <div class="result-box difficulty-box" id="resultDifficultyBox">
                            <span class="label">ƒê·ªô kh√≥</span>
                            <div class="value" id="resDifficulty">---</div>
                            <div class="sub-value" id="resCaseName">Case #--</div>
                        </div>

                        <div class="metrics-grid">
                            <div class="metric">
                                <span class="label">M·∫´u / Ng√†y (Base)</span>
                                <span class="value" id="resDaily">--</span>
                            </div>
                            <div class="metric">
                                <span class="label">∆Ø·ªõc t√≠nh FW</span>
                                <span class="value highlight" id="resDays">-- ng√†y</span>
                            </div>
                        </div>

                        <!-- FACTOR BREAKDOWN -->
                        <div class="factor-breakdown" id="factorBreakdown">
                            <div class="factor-header">üìà Factor Adjustment</div>
                            <div class="factor-rows">
                                <div class="factor-row">
                                    <span class="factor-label">üè¢ Panel Source</span>
                                    <span class="factor-value" id="factorTraffic">√ó1.00</span>
                                </div>
                                <div class="factor-row">
                                    <span class="factor-label">üìä Quota Skew</span>
                                    <span class="factor-value" id="factorQuota">√ó1.00</span>
                                </div>
                                <div class="factor-row">
                                    <span class="factor-label">üîç QC Buffer</span>
                                    <span class="factor-value" id="factorQC">+10%</span>
                                </div>
                                <div class="factor-row">
                                    <span class="factor-label">üìÖ Timing</span>
                                    <span class="factor-value" id="factorTiming">√ó1.00</span>
                                </div>
                            </div>
                            <div class="factor-total">
                                <span>Adjusted Daily Rate</span>
                                <span class="factor-value-total" id="adjustedDaily">-- samples/day</span>
                            </div>
                        </div>

                        <div class="cpi-row">
                            <span class="label">üí∞ CPI Estimate (VN)</span>
                            <span class="value" id="resCPI">$ --</span>
                        </div>
                    </div>

                    <!-- SUGGESTIONS -->
                    <div class="card suggestion-card">
                        <div class="card-header">
                            <h2>üí° G·ª£i √Ω t·ª´ H·ªá th·ªëng</h2>
                        </div>
                        <ul class="suggestion-list" id="suggestionList">
                            <li class="placeholder">Nh·∫≠p th√¥ng tin ƒë·ªÉ xem g·ª£i √Ω...</li>
                        </ul>
                    </div>

                    <!-- EXPERT CONCLUSION -->
                    <div class="card conclusion-card">
                        <div class="card-header">
                            <h2>‚≠ê K·∫øt lu·∫≠n c·ªßa B·∫°n (Expert)</h2>
                        </div>

                        <div class="conclusion-main">
                            <label>Th·ªùi gian FW ch√≠nh th·ª©c</label>
                            <div class="conclusion-input-row">
                                <input type="number" id="expertDays" placeholder="--" min="1" class="expert-days-input">
                                <span class="unit">ng√†y</span>
                            </div>
                            <div class="quick-buffer">
                                <span>Quick buffer:</span>
                                <button class="buffer-btn" data-add="1">+1</button>
                                <button class="buffer-btn" data-add="2">+2</button>
                                <button class="buffer-btn" data-add="3">+3</button>
                            </div>
                        </div>

                        <div class="conclusion-warning hidden" id="conclusionWarning"></div>

                        <div class="form-group">
                            <label for="expertNote">Ghi ch√∫ (t√πy ch·ªçn)</label>
                            <textarea id="expertNote" placeholder="L√Ω do ch·ªçn s·ªë ng√†y n√†y, c√°c y·∫øu t·ªë ƒë√£ c√¢n nh·∫Øc..."
                                rows="2"></textarea>
                        </div>

                        <button type="button" class="save-btn" id="saveBtn">
                            üíæ L∆∞u k·∫øt lu·∫≠n
                        </button>
                        <div class="save-status" id="saveStatus"></div>

                        <!-- SUMMARY TABLE (shown after save) -->
                        <div class="summary-table-container hidden" id="summaryTableContainer">
                            <div class="summary-header">
                                <h3>üìã B·∫£ng T√≥m T·∫Øt</h3>
                                <button type="button" class="copy-btn" id="copySummaryBtn" title="Copy to clipboard">üìã
                                    Copy</button>
                            </div>
                            <table class="summary-table" id="summaryTable">
                                <thead>
                                    <tr>
                                        <th style="width:45%">Th√¥ng s·ªë</th>
                                        <th>Gi√° tr·ªã</th>
                                        <th style="width:40px">Xo√°</th>
                                    </tr>
                                </thead>
                                <tbody id="summaryTableBody">
                                    <!-- Dynamic content generated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- RECENT HISTORY -->
                    <div class="card history-card">
                        <div class="card-header">
                            <h2>üìú L·ªãch s·ª≠ g·∫ßn ƒë√¢y</h2>
                        </div>
                        <div class="history-list" id="historyList">
                            <p class="placeholder">Ch∆∞a c√≥ l·ªãch s·ª≠...</p>
                        </div>
                    </div>
                </section>
            </div><!-- /.main-content -->
        </main>

        <footer class="app-footer">
            <div class="footer-content">
                <img src="logo.png" alt="FW Tools" class="footer-logo">
                <p>¬© 2024 dien.pham Fieldwork Tools | Sample Size Calculator v3.0</p>
                <p class="copyright-email">phamdongdien19@gmail.com | All rights reserved</p>
            </div>
        </footer>
    </div>

    <script type="module" src="index.js"></script>
</body>

</html>